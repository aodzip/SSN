<style>
    #songDiv a{
        color:#2a6496;
    }
    .label{
        margin-right:10px;
    }
    .tagContent .tag{
        margin-right:10px;
    }
</style>
<div id="songDiv" class="container" style="width:750px;">
    <h3 class="songTitle page-header">单曲页面</h3>
    
    <p><span class="label bg-info">UP主</span><a href="#" class="songUp tag"></a></p>
    <p><span class="label bg-info">日期</span><span class="songDate"></span></p>
    <p class="songTagP"><span class="label bg-info">标签</span><span class="tagContent"></span></p>
    <p><span class="label bg-info">PV</span></p>
    <video preload loop controls class="songPv" style="width:100%;height:400px;background-color: black;">
    </video>
    <p><span class="label bg-info">下载</span><span class="songDownload"><button class="btn btn-default btnDownload">点此下载</button></span></p>
    <p><span class="label bg-info">介绍</span></p>
    <pre class="songDesc">
    </pre>
</div>
<script>
	function downloadFile(fileName, content){
		var aLink = document.createElement('a');
		var blob = new Blob([content]);
		var evt = document.createEvent("HTMLEvents");
		evt.initEvent("click", false, false);
		aLink.download = fileName;
		aLink.href = URL.createObjectURL(blob);
		aLink.dispatchEvent(evt);
	}
    var hash = window.location.hash;
    var sm = hash.replace("#/song/","");
    if(sm.indexOf("?")>0){
        sm = sm.substring(0,sm.indexOf("?"));
    }
    //sm = sm.replace(".mp3","");
    $.get(myapp.apibase,{"cmd":"query","id":sm},function(data){
        data = JSON.parse(data);
        var tags = data.TAG.split(",");
        tags.splice(0,1);
        $("#songDiv .songTitle").text(data.TITLE);
        //up主信息
        $("#songDiv .songUp").text(data.AUTHOR);
        $("#songDiv .songUp").attr("href","#/list/author/jps"+data.AUTHOR+"jpe/1");
        //时间信息
        $("#songDiv .songDate").text(data.DATE);
        //歌曲标签
         $("#songDiv .songTagP .tagContent").text("");
        for(i in tags){
            var tag = tags[i];
            $("#songDiv .songTagP .tagContent").append($("<a class=tag href=#/list/tag/jps"+tag+"jpe/1>"+tag+"</a>"));
            if(parseInt(i)!== tags.length-1){
                $("#songDiv .songTagP .tagContent").append("");   
            }
        }
        //pv资源
        $("#songDiv .songPv").attr("src",myapp.filebase+data.ID+".mp4");
        $(".btnDownloadMP3").attr("alt",myapp.filebase+data.ID+".mp3");
        //歌曲描述
        $("#songDiv .songDesc").text(data.DESCRIPTION);
        //点击事件，转码
        $("#songDiv").click(function(event){
            var $target = $(event.target);
            if($target.hasClass("tag")){
                console.log("[miku:jpcode转码]");
                var href = $target.attr("href")
                window.location.href = myapp.jpcoder.encodejp(href);
                return false;
            }
        });
        
        $(".btnDownloadMP3").click(function(){
        	//window.open($(".btnDownloadMP3").attr("alt"));
			downloadFile(text(data.TITLE)+".mp3", $(".btnDownloadMP3"))
        }
        );
    });
</script>